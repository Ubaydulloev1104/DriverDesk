<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="DriverDesk.Pages.HistoryPage"
    Title="История заказов">

    <Grid RowDefinitions="Auto, Auto, *, Auto" Padding="12" RowSpacing="10">

        <!-- Вкладки -->
        <HorizontalStackLayout Grid.Row="0" Spacing="8" HorizontalOptions="Center">
            <Button x:Name="AllOrdersButton"
                    Text="Все"
                    Clicked="OnAllOrdersTabClicked"
                    BackgroundColor="#e0e0e0" />
            <Button x:Name="CompletedOrdersButton"
                    Text="Завершённые"
                    Clicked="OnCompletedOrdersTabClicked" />
        </HorizontalStackLayout>

        <!-- Поиск -->
        <SearchBar x:Name="SearchBar"
                   Grid.Row="1"
                   Placeholder="Поиск по имени клиента..."
                   TextChanged="OnSearchTextChanged"/>

        <!-- Список заказов с прокруткой -->
        <ScrollView Grid.Row="2">
            <CollectionView x:Name="OrdersCollectionView"
                            IsGrouped="True"
                            SelectionMode="None"
                            Margin="0,4"
                            VerticalOptions="FillAndExpand">
                <CollectionView.GestureRecognizers>
                    <PinchGestureRecognizer PinchUpdated="OnPinchUpdated"/>
                </CollectionView.GestureRecognizers>

                <!-- Заголовок группы -->
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="#f0f6ff"
                               CornerRadius="8"
                               Padding="8"
                               Margin="0,6,0,4"
                               HasShadow="False">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Label Text="{Binding Key}" FontAttributes="Bold" FontSize="16" />
                                <Label Grid.Column="1" Text="{Binding ItemCount, StringFormat='Всего: {0}'}"
                                       FontSize="14" TextColor="Gray" HorizontalOptions="End" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>

                <!-- Элемент заказа -->
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="10" Margin="0,4"
                               CornerRadius="10"
                               BorderColor="LightGray"
                               HasShadow="True"
                               BackgroundColor="{Binding BackgroundColor}">
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                    <Label Text="{Binding CustomerName}" 
                                           FontAttributes="Bold" 
                                           FontSize="{Binding FontSize}" />
                                    <Label Text="{Binding CustomerPhone}" 
                                           FontSize="{Binding FontSize}" 
                                           TextColor="Gray" />
                                    <Label Text="{Binding Description}" 
                                           FontSize="{Binding FontSize}" />
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="{Binding PickupDateTime, StringFormat='{0:dd.MM.yyyy HH:mm}'}" 
                                               FontSize="{Binding FontSize}" 
                                               TextColor="DarkBlue"/>
                                        <Label Text="{Binding StatusText}" 
                                               TextColor="{Binding StatusColor}" 
                                               FontSize="{Binding FontSize}" 
                                               FontAttributes="Italic"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- Нижний счётчик -->
        <Label x:Name="TotalCountLabel"
               Grid.Row="3"
               Text="Всего заказов: 0"
               FontAttributes="Bold"
               HorizontalOptions="End"
               Margin="0,6,0,0"/>
    </Grid>
</ContentPage>
